<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bike Project Manager</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDcnPKvVuiru2S7HcbCJiGrl3H3Zovoafs",
            authDomain: "xsr-project.firebaseapp.com",
            projectId: "xsr-project",
            storageBucket: "xsr-project.firebasestorage.app",
            messagingSenderId: "319801419019",
            appId: "1:319801419019:web:8e3ac10e1195cf2d8e2e0e",
            databaseURL: "https://xsr-project-default-rtdb.asia-southeast1.firebasedatabase.app"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // --- LOGIKA MULTI-USER (ANTI HURUF KAPITAL) ---
        let rawInput = localStorage.getItem('xsr_user_key');
        if (!rawInput) {
            rawInput = prompt("Masukkan Username (Huruf besar/kecil tidak berpengaruh):") || "guest";
        }
        // Ubah ke kecil semua dan hapus spasi
        let userKey = rawInput.toLowerCase().trim().replace(/\s+/g, '');
        localStorage.setItem('xsr_user_key', userKey);

        const userPath = `users/${userKey}`;
        const dataRef = ref(db, userPath);

        let state = { 
            projectTitle: "Project: " + userKey.toUpperCase(), 
            history: [], 
            checkedStates: {}, 
            customItems: [] 
        };

        // DATA DEFAULT KHUSUS UNTUK USER: JACQUELYN
        const jacquelynDefaults = [
            { name: "Helm KYT R2R", price: 2100000 },
            { name: "Action Cam", price: 1000000 },
            { name: "Intercom Budget/Ejeas", price: 350000 },
            { name: "Stang Clubman", price: 132000 },
            { name: "Spion Bar End", price: 100000 },
            { name: "Tail Tidy", price: 100000 },
            { name: "Mudguard", price: 130000 },
            { name: "Phone Holder GUB", price: 50000 },
            { name: "Radiator Guard", price: 150000 }
        ];

        window.saveData = () => { set(dataRef, state); };

        window.editTitle = () => {
            const newTitle = prompt("Ganti Nama Project:", state.projectTitle);
            if (newTitle) { state.projectTitle = newTitle; window.saveData(); }
        };

        window.logout = () => {
            if(confirm("Logout dan ganti user?")) {
                localStorage.removeItem('xsr_user_key');
                location.reload();
            }
        };

        window.addNewItem = () => {
            const name = document.getElementById('item-name').value;
            const price = parseFloat(document.getElementById('item-price').value);
            if (!name || !price) return;
            if(!state.customItems) state.customItems = [];
            state.customItems.push({ name, price });
            window.saveData();
            document.getElementById('item-name').value = '';
            document.getElementById('item-price').value = '';
        };

        window.addTransaction = (type) => {
            const desc = document.getElementById('desc-input').value;
            const amount = parseFloat(document.getElementById('amount-input').value);
            if (!desc || !amount) return;
            if(!state.history) state.history = [];
            state.history.push({ desc, amount, type });
            window.saveData();
            document.getElementById('desc-input').value = '';
            document.getElementById('amount-input').value = '';
        };

        window.toggle = (i) => {
            if(!state.checkedStates) state.checkedStates = {};
            state.checkedStates[i] = !state.checkedStates[i];
            window.saveData();
        };

        onValue(dataRef, (snapshot) => {
            const data = snapshot.val();
            if (data) { 
                state = data; 
                render(); 
            } else { 
                // Jika user baru adalah 'jacquelyn', masukkan data bawaan
                if (userKey === 'jacquelyn') {
                    state = { 
                        projectTitle: "Project: XSR CAFE RACER", 
                        history: [], 
                        checkedStates: {}, 
                        customItems: jacquelynDefaults 
                    };
                } else {
                    state = { 
                        projectTitle: "Project: " + userKey.toUpperCase(), 
                        history: [], 
                        checkedStates: {}, 
                        customItems: [] 
                    };
                }
                window.saveData();
            }
        });

        function render() {
            document.getElementById('main-title').innerText = state.projectTitle;
            const checklistBody = document.getElementById('checklist-body');
            const tIn = document.getElementById('table-in');
            const tOut = document.getElementById('table-out');
            let wallet = 0, remainingTarget = 0, spentTarget = 0;
            
            const history = state.history || [];
            const customItems = state.customItems || [];
            const checkedStates = state.checkedStates || {};

            history.forEach(h => { wallet += (h.type === 'IN' ? h.amount : -h.amount); });

            tIn.innerHTML = ''; tOut.innerHTML = '';
            history.slice().reverse().forEach(h => {
                const row = `<tr><td>${h.desc}</td><td style="text-align: right;" class="${h.type=='IN'?'txt-success':'txt-danger'}">${h.type=='IN'?'+':'-'} ${new Intl.NumberFormat('id-ID').format(h.amount)}</td></tr>`;
                if (h.type === 'IN') tIn.innerHTML += row; else tOut.innerHTML += row;
            });

            checklistBody.innerHTML = '';
            customItems.forEach((item, i) => {
                const isChecked = checkedStates[i];
                if (isChecked) { spentTarget += item.price; wallet -= item.price; } 
                else { remainingTarget += item.price; }
                checklistBody.innerHTML += `<tr class="${isChecked ? 'checked' : ''}"><td class="col-check"><input type="checkbox" ${isChecked ? 'checked' : ''} onmousedown="toggle(${i})" onclick="return false;"></td><td class="col-name">${item.name}</td><td class="col-price">${new Intl.NumberFormat('id-ID').format(item.price)}</td></tr>`;
            });

            document.getElementById('wallet-val').innerText = "Rp" + new Intl.NumberFormat('id-ID').format(wallet);
            document.getElementById('target-val').innerText = "Rp" + new Intl.NumberFormat('id-ID').format(remainingTarget);
            
            const totalPlan = customItems.reduce((a, b) => a + b.price, 0);
            const percent = totalPlan > 0 ? Math.round((spentTarget / totalPlan) * 100) : 0;
            document.getElementById('progress-bar').style.width = percent + '%';
            document.getElementById('progress-percent').innerText = percent + '% COMPLETED';

            if (percent === 100 && totalPlan > 0 && !window.hasCelebrated) {
                confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#D000FF', '#00ff88', '#ffffff'] });
                window.hasCelebrated = true;
            } else if (percent < 100) { window.hasCelebrated = false; }
        }
    </script>
    <style>
        :root { --bg-color: #0d0d0d; --card-bg: #161616; --text-color: #e0e0e0; --accent-color: #D000FF; --success: #00ff88; --danger: #ff4d4d; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg-color); color: var(--text-color); display: flex;
